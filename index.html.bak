<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Wetter">
<meta name="theme-color" content="#070b14" id="themeColorMeta">
<title>Wetter</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icons/favicon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--bg:#070b14;--bg2:#0c1221;--card:rgba(255,255,255,0.035);--card-h:rgba(255,255,255,0.07);--bdr:rgba(255,255,255,0.06);--bdr-h:rgba(94,234,212,0.2);--acc:#5eead4;--acc-dim:rgba(94,234,212,0.12);--acc-glow:rgba(94,234,212,0.06);--txt:#e2e8f0;--dim:rgba(226,232,240,0.5);--mid:rgba(226,232,240,0.75);--warm:#fb923c;--cool:#38bdf8;--red:#f87171;--rain:#60a5fa;--mono:'JetBrains Mono',monospace;--sans:'Outfit',system-ui,sans-serif;--safe-top:env(safe-area-inset-top,0px);--safe-bot:env(safe-area-inset-bottom,0px)}
[data-theme="light"]{--bg:#e8ecf0;--bg2:#f1f5f9;--card:rgba(0,0,0,0.04);--card-h:rgba(0,0,0,0.08);--bdr:rgba(0,0,0,0.08);--bdr-h:rgba(20,184,166,0.25);--acc:#0d9488;--acc-dim:rgba(20,184,166,0.12);--acc-glow:rgba(20,184,166,0.08);--txt:#1e293b;--dim:rgba(30,41,59,0.5);--mid:rgba(30,41,59,0.75);--warm:#ea580c;--cool:#0284c7;--red:#dc2626;--rain:#2563eb}
[data-theme="weatherpro"]{--bg:#1a3a5c;--bg2:#234b73;--card:rgba(255,255,255,0.08);--card-h:rgba(255,255,255,0.14);--bdr:rgba(255,255,255,0.1);--bdr-h:rgba(250,204,21,0.3);--acc:#facc15;--acc-dim:rgba(250,204,21,0.15);--acc-glow:rgba(250,204,21,0.08);--txt:#f8fafc;--dim:rgba(248,250,252,0.55);--mid:rgba(248,250,252,0.8);--warm:#fbbf24;--cool:#7dd3fc;--red:#fca5a5;--rain:#93c5fd}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden;font-family:var(--sans);color:var(--txt);background:var(--bg);-webkit-font-smoothing:antialiased;-webkit-tap-highlight-color:transparent}
#app{height:100%;display:flex;flex-direction:column;max-width:520px;margin:0 auto;background:linear-gradient(175deg,var(--bg) 0%,var(--bg2) 50%,var(--bg2) 100%);position:relative;overflow:hidden}
.glow{position:absolute;top:-100px;right:-80px;width:300px;height:300px;background:radial-gradient(circle,var(--acc-glow) 0%,transparent 70%);pointer-events:none;z-index:0}
header{padding:calc(14px + var(--safe-top)) 18px 8px;display:flex;align-items:center;justify-content:space-between;position:relative;z-index:10;flex-shrink:0}
header .brand{font-size:11px;font-weight:500;letter-spacing:2.5px;text-transform:uppercase;color:var(--acc);margin-bottom:1px}
header h1{font-size:22px;font-weight:700;letter-spacing:-0.3px}
.nav{display:flex;gap:4px}
.nav button{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:var(--card);border:1px solid var(--bdr);color:var(--dim);cursor:pointer;transition:all 0.2s;font-size:17px}
.nav button.active{background:var(--acc-dim);border-color:var(--bdr-h);color:var(--acc)}
.chips{padding:0 18px 8px;display:flex;gap:6px;flex-wrap:wrap;position:relative;z-index:5;flex-shrink:0}
.chip{padding:6px 14px;border-radius:20px;border:1px solid var(--bdr);background:var(--card);color:var(--mid);font:500 13px var(--sans);cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:4px}
.chip.active{border-color:var(--acc);background:var(--acc-dim);color:var(--acc)}
.chip .star{font-size:9px}
.main{flex:1;overflow-y:auto;overflow-x:hidden;padding:0 18px;position:relative;z-index:5;-webkit-overflow-scrolling:touch;scroll-behavior:smooth;padding-bottom:calc(24px + var(--safe-bot))}
.main::-webkit-scrollbar{width:3px}
.main::-webkit-scrollbar-thumb{background:rgba(128,128,128,0.2);border-radius:3px}
.hero{background:linear-gradient(135deg,var(--acc-glow) 0%,transparent 100%);border-radius:22px;padding:24px 20px 20px;margin-bottom:12px;border:1px solid var(--bdr);position:relative;overflow:hidden}
.hero .bg-icon{position:absolute;top:-30px;right:-10px;font-size:100px;opacity:0.12;line-height:1;pointer-events:none}
.hero .loc{font-size:15px;color:var(--mid);margin-bottom:2px}
.hero .temp-row{display:flex;align-items:baseline;gap:6px}
.hero .temp{font-size:58px;font-weight:300;letter-spacing:-3px;line-height:1}
.hero .unit{font-size:28px;opacity:0.15;font-weight:300}
.hero .desc{font-size:15px;color:var(--mid);margin-top:2px}
.hero .icon-big{font-size:48px;margin-top:4px}
.hero-top{display:flex;justify-content:space-between;align-items:flex-start}
.stats{display:flex;gap:16px;margin-top:16px;flex-wrap:wrap}
.stat-label{font-size:11px;color:var(--dim);letter-spacing:0.5px;text-transform:uppercase;margin-bottom:2px}
.stat-val{font:600 15px var(--mono)}
.stat-sub{font-size:12px;color:var(--dim)}
.strip{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px}
.strip-card{background:var(--card);border:1px solid var(--bdr);border-radius:14px;padding:12px 8px;text-align:center}
.strip-card .ic{font-size:20px;margin-bottom:3px}
.strip-card .lb{font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:2px}
.strip-card .vl{font:600 15px var(--mono)}
.sec-title{font-size:12px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--dim);margin-bottom:10px;padding-left:2px}
.fday{width:100%;display:grid;grid-template-columns:54px 32px 1fr 62px 22px;align-items:center;gap:8px;padding:12px;margin-bottom:2px;background:var(--card);border:1px solid var(--bdr);border-radius:14px;color:var(--txt);cursor:pointer;font:14px var(--sans);text-align:left;transition:all 0.2s;-webkit-appearance:none}
.fday.open{border-radius:14px 14px 0 0;background:var(--card-h);border-color:var(--bdr-h)}
.fday:active{transform:scale(0.99)}
.fday .d-name{font-weight:600;font-size:14px}
.fday .d-date{font-size:11px;color:var(--dim)}
.fday .d-icon{font-size:22px}
.tbar{flex:1;height:5px;border-radius:3px;background:rgba(128,128,128,0.15);position:relative;overflow:hidden}
.tbar-fill{position:absolute;top:0;bottom:0;border-radius:3px;background:linear-gradient(90deg,var(--cool),var(--acc),var(--warm))}
.fday .temps{text-align:right;font:500 13px var(--mono);white-space:nowrap}
.fday .temps .lo{color:var(--cool)}
.fday .temps .hi{color:var(--warm)}
.fday .temps .sep{color:var(--dim);margin:0 2px}
.fday .arrow{color:var(--dim);font-size:11px;text-align:center;transition:transform 0.2s}
.fday.open .arrow{transform:rotate(180deg)}
.detail{background:var(--card-h);border-radius:0 0 14px 14px;border:1px solid var(--bdr-h);border-top:none;padding:12px 10px 14px;margin-bottom:4px;animation:slideIn 0.2s ease}
.detail .sum{display:flex;gap:12px;flex-wrap:wrap;padding:0 6px 12px;border-bottom:1px solid var(--bdr);margin-bottom:10px}
.hours{overflow-x:auto;display:flex;gap:3px;padding-bottom:4px}
.hours::-webkit-scrollbar{height:3px}
.hours::-webkit-scrollbar-thumb{background:rgba(128,128,128,0.15);border-radius:3px}
.hcell{min-width:58px;padding:8px 6px;text-align:center;border-radius:12px;background:var(--card);font-size:12px;flex-shrink:0}
.hcell .ht{color:var(--dim);font:400 11px var(--mono);margin-bottom:3px}
.hcell .hi{font-size:19px;margin-bottom:2px}
.hcell .ht2{font-weight:600;font-size:14px;margin-bottom:2px}
.hcell .hp{color:var(--rain);font-size:11px}
.hcell .hw{color:var(--dim);font-size:10px;margin-top:2px}
.attr{margin-top:20px;padding:14px;text-align:center;font-size:11px;color:var(--dim);line-height:1.5}
.attr a{color:var(--acc);text-decoration:none}
.loc-row{display:flex;align-items:center;gap:10px;padding:14px;margin-bottom:6px;background:var(--card);border-radius:14px;border:1px solid var(--bdr);transition:all 0.2s}
.loc-row.is-def{border-color:var(--bdr-h)}
.loc-row .star-btn{background:none;border:none;cursor:pointer;padding:0;font-size:20px;transition:all 0.2s;filter:grayscale(1) opacity(0.3)}
.loc-row.is-def .star-btn{filter:none}
.loc-row .info{flex:1;min-width:0}
.loc-row .name{font-weight:600;font-size:15px}
.loc-row .sub{font-size:12px;color:var(--dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.def-badge{font-size:9px;padding:3px 8px;border-radius:8px;background:var(--acc-dim);color:var(--acc);font-weight:600}
.btn-sm{background:var(--card-h);border:none;border-radius:10px;padding:6px 10px;cursor:pointer;font:12px var(--sans);color:var(--mid)}
.btn-rm{background:rgba(248,113,113,0.1);color:var(--red);font-size:14px;line-height:1}
.btn-add{width:100%;padding:14px;margin-top:14px;background:var(--acc-dim);border:1px dashed var(--acc);border-radius:14px;color:var(--acc);font:600 14px var(--sans);cursor:pointer}
.search-wrap{position:relative;margin-bottom:14px}
.search-wrap input{width:100%;padding:14px 16px 14px 42px;background:var(--card);border:1px solid var(--bdr);border-radius:14px;color:var(--txt);font:400 15px var(--sans);outline:none}
.search-wrap input:focus{border-color:var(--acc)}
.search-wrap input::placeholder{color:var(--dim)}
.search-wrap .sicon{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:14px;opacity:0.4}
.sresult{width:100%;display:flex;align-items:center;gap:12px;padding:14px;margin-bottom:4px;background:var(--card);border:1px solid var(--bdr);border-radius:14px;color:var(--txt);cursor:pointer;font:14px var(--sans);text-align:left;transition:all 0.15s;-webkit-appearance:none}
.sresult:active{transform:scale(0.98)}
.sresult .pin{font-size:20px}
.sresult .sinfo{flex:1;min-width:0}
.sresult .sname{font-weight:600;font-size:15px}
.sresult .ssub{font-size:12px;color:var(--dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sresult .plus{color:var(--acc);font-size:18px}
.sresult .exists{font-size:11px;padding:3px 8px;border-radius:8px;background:var(--card-h);color:var(--dim)}
.err-box{padding:14px 16px;margin-bottom:12px;border-radius:14px;background:rgba(248,113,113,0.08);border:1px solid rgba(248,113,113,0.2);color:var(--red);font-size:13px;line-height:1.5}
.err-box button{display:block;margin-top:8px;padding:6px 16px;border-radius:8px;background:rgba(248,113,113,0.12);border:none;color:var(--red);font:500 12px var(--sans);cursor:pointer}
.empty{padding:50px 20px;text-align:center}
.empty .eicon{font-size:48px;margin-bottom:14px;opacity:0.25}
.empty .emsg{font-size:14px;color:var(--dim);margin-bottom:18px}
.empty button{padding:12px 28px;border-radius:14px;background:var(--acc-dim);border:1px solid var(--acc);color:var(--acc);font:600 14px var(--sans);cursor:pointer}
.spinner{width:28px;height:28px;margin:40px auto;border:2px solid var(--bdr);border-top-color:var(--acc);border-radius:50%;animation:spin 0.8s linear infinite}
.spinner.sm{width:20px;height:20px;margin:14px auto}
.hint{padding:36px 20px;text-align:center}
.hint .hic{font-size:40px;margin-bottom:10px;opacity:0.2}
.hint p{font-size:14px;color:var(--dim)}
.hidden{display:none !important}
.offline-bar{display:none;padding:7px 18px;background:rgba(251,146,60,0.15);color:var(--warm);font-size:12px;text-align:center;font-weight:500}
.offline-bar.show{display:block}
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;margin-bottom:6px;background:var(--card);border-radius:14px;border:1px solid var(--bdr)}
.setting-row .label{font-size:15px;font-weight:500}
.setting-row .sublabel{font-size:12px;color:var(--dim);margin-top:2px}
.theme-btns{display:flex;gap:6px}
.theme-btn{width:38px;height:38px;border-radius:10px;border:2px solid var(--bdr);cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;font-size:15px}
.theme-btn.active{border-color:var(--acc);box-shadow:0 0 0 2px var(--acc-dim)}
.theme-btn.dark{background:linear-gradient(135deg,#070b14,#1a1a2e)}
.theme-btn.light{background:linear-gradient(135deg,#e8ecf0,#f1f5f9)}
.theme-btn.weatherpro{background:linear-gradient(135deg,#1a3a5c,#234b73)}
.netatmo-card{background:var(--card);border:1px solid var(--bdr);border-radius:16px;padding:16px;margin-bottom:10px}
.netatmo-card .nc-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.netatmo-card .nc-name{font-weight:600;font-size:16px}
.netatmo-card .nc-time{font-size:12px;color:var(--dim)}
.netatmo-card .nc-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.netatmo-card .nc-item{background:var(--card-h);border-radius:10px;padding:10px 12px}
.netatmo-card .nc-item .nc-label{font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:2px}
.netatmo-card .nc-item .nc-val{font:600 20px var(--mono)}
.netatmo-card .nc-item .nc-unit{font-size:13px;color:var(--dim);font-weight:400}
.netatmo-card .nc-modules{margin-top:12px;padding-top:12px;border-top:1px solid var(--bdr)}
.netatmo-card .nc-module{display:flex;justify-content:space-between;align-items:center;padding:8px 0}
.netatmo-card .nc-module:not(:last-child){border-bottom:1px solid var(--bdr)}
.netatmo-card .nc-mod-name{font-size:14px;color:var(--mid)}
.netatmo-card .nc-mod-val{font:600 15px var(--mono)}
.form-group{margin-bottom:14px}
.form-group label{display:block;font-size:14px;font-weight:500;margin-bottom:6px}
.form-group input{width:100%;padding:12px 14px;background:var(--card);border:1px solid var(--bdr);border-radius:12px;color:var(--txt);font:400 14px var(--mono);outline:none}
.form-group input:focus{border-color:var(--acc)}
.form-group .hint-text{font-size:12px;color:var(--dim);margin-top:4px}
.btn-primary{width:100%;padding:14px;background:var(--acc);border:none;border-radius:14px;color:#000;font:600 14px var(--sans);cursor:pointer}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{opacity:0;max-height:0}to{opacity:1;max-height:700px}}
@keyframes spin{to{transform:rotate(360deg)}}
.fade-in{animation:fadeIn 0.4s ease}
</style>
</head>
<body>
<div id="app">
<div class="glow"></div>
<div class="offline-bar" id="offlineBar">üì° Offline ‚Äì letzte Daten</div>
<header>
<div><div class="brand">Open-Meteo</div><h1>Wetter</h1></div>
<div class="nav">
<button id="navWeather" class="active" onclick="showView('weather')">‚òÄÔ∏è</button>
<button id="navNetatmo" onclick="showView('netatmo')">üè†</button>
<button id="navManage" onclick="showView('manage')">üìç</button>
<button id="navSettings" onclick="showView('settings')">‚öôÔ∏è</button>
</div>
</header>
<div class="chips" id="chips"></div>
<div class="main" id="mainScroll">
<div id="viewWeather" class="fade-in"></div>
<div id="viewNetatmo" class="hidden fade-in"></div>
<div id="viewManage" class="hidden fade-in"></div>
<div id="viewSettings" class="hidden fade-in"></div>
</div>
</div>
<script>
let locations=JSON.parse(localStorage.getItem('wetter_locs')||'[]');
let defaultId=localStorage.getItem('wetter_def')||null;
let selectedId=null,weatherData=null,hourlyGrouped=null,expandedDay=null,currentView='weather',searchTimeout=null;
let currentTheme=localStorage.getItem('wetter_theme')||'dark';
let netatmoStations=JSON.parse(localStorage.getItem('netatmo_stations')||'[]');
let netatmoData={};

const themeColors={dark:'#070b14',light:'#e8ecf0',weatherpro:'#1a3a5c'};
function setTheme(t){currentTheme=t;document.documentElement.setAttribute('data-theme',t);localStorage.setItem('wetter_theme',t);document.getElementById('themeColorMeta').setAttribute('content',themeColors[t]);if(currentView==='settings')renderSettings();}
setTheme(currentTheme);

const WMO={0:["Klar","‚òÄÔ∏è","üåô"],1:["√úberwiegend klar","üå§Ô∏è","üåô"],2:["Teilweise bew√∂lkt","‚õÖ","‚òÅÔ∏è"],3:["Bew√∂lkt","‚òÅÔ∏è","‚òÅÔ∏è"],45:["Nebel","üå´Ô∏è","üå´Ô∏è"],48:["Reifnebel","üå´Ô∏è","üå´Ô∏è"],51:["Leichter Nieselregen","üå¶Ô∏è","üåßÔ∏è"],53:["Nieselregen","üå¶Ô∏è","üåßÔ∏è"],55:["Starker Nieselregen","üåßÔ∏è","üåßÔ∏è"],61:["Leichter Regen","üå¶Ô∏è","üåßÔ∏è"],63:["Regen","üåßÔ∏è","üåßÔ∏è"],65:["Starker Regen","üåßÔ∏è","üåßÔ∏è"],71:["Leichter Schnee","üå®Ô∏è","üå®Ô∏è"],73:["Schnee","‚ùÑÔ∏è","‚ùÑÔ∏è"],75:["Starker Schnee","‚ùÑÔ∏è","‚ùÑÔ∏è"],80:["Leichte Schauer","üå¶Ô∏è","üåßÔ∏è"],81:["Schauer","üåßÔ∏è","üåßÔ∏è"],82:["Starke Schauer","‚õàÔ∏è","‚õàÔ∏è"],95:["Gewitter","‚õàÔ∏è","‚õàÔ∏è"],96:["Gewitter mit Hagel","‚õàÔ∏è","‚õàÔ∏è"]};
function wmo(c,d){const w=WMO[c]||["Unbekannt","‚ùì","‚ùì"];return{label:w[0],icon:d?w[1]:w[2]};}
function windDir(d){return["N","NNO","NO","ONO","O","OSO","SO","SSO","S","SSW","SW","WSW","W","WNW","NW","NNW"][Math.round(d/22.5)%16];}
function fmtDay(s){const d=new Date(s+"T00:00:00");return{short:["So","Mo","Di","Mi","Do","Fr","Sa"][d.getDay()],date:d.getDate()+". "+["Jan","Feb","M√§r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"][d.getMonth()]};}
function fmtTime(s){return new Date(s).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});}
function fmtTimeAgo(ts){const m=Math.floor((Date.now()/1000-ts)/60);if(m<1)return"gerade eben";if(m<60)return`vor ${m} Min`;const h=Math.floor(m/60);return h<24?`vor ${h} Std`:`vor ${Math.floor(h/24)} Tag(en)`;}
function saveLocs(){localStorage.setItem('wetter_locs',JSON.stringify(locations));}
function saveDef(){localStorage.setItem('wetter_def',defaultId||'');}
function selLoc(){return locations.find(l=>l.id===selectedId);}
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}
function stat(l,v,s){return`<div style="min-width:56px"><div class="stat-label">${l}</div><div class="stat-val">${v}</div>${s?'<div class="stat-sub">'+s+'</div>':''}</div>`;}
function tile(i,l,v){return`<div class="strip-card"><div class="ic">${i}</div><div class="lb">${l}</div><div class="vl">${v}</div></div>`;}
function emptyHTML(m,b,o){return`<div class="empty"><div class="eicon">üåç</div><div class="emsg">${m}</div>${b?`<button onclick="${o}">${b}</button>`:''}</div>`;}
function cacheWeather(id,d){try{localStorage.setItem('wetter_cache_'+id,JSON.stringify({ts:Date.now(),data:d}));}catch(e){}}
function getCachedWeather(id){try{const c=JSON.parse(localStorage.getItem('wetter_cache_'+id));if(c&&c.data)return c.data;}catch(e){}return null;}

window.addEventListener('online',()=>{document.getElementById('offlineBar').classList.remove('show');if(selectedId)fetchWeather();});
window.addEventListener('offline',()=>{document.getElementById('offlineBar').classList.add('show');});

function showView(v){
currentView=v;
document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
const m={weather:'navWeather',netatmo:'navNetatmo',manage:'navManage',settings:'navSettings'};
const e=document.getElementById(m[v]);if(e)e.classList.add('active');
['Weather','Netatmo','Manage','Settings'].forEach(n=>{const el=document.getElementById('view'+n);if(el)el.classList.toggle('hidden',n.toLowerCase()!==v);});
document.getElementById('chips').classList.toggle('hidden',v!=='weather');
if(v==='weather'){renderChips();renderWeather();}
if(v==='netatmo')renderNetatmo();
if(v==='manage')renderManage();
if(v==='settings')renderSettings();
document.getElementById('mainScroll').scrollTop=0;
}

function renderChips(){const el=document.getElementById('chips');if(!locations.length){el.innerHTML='';return;}el.innerHTML=locations.map(l=>`<button class="chip ${l.id===selectedId?'active':''}" onclick="selectLocation('${l.id}')">${l.id===defaultId?'<span class="star">‚≠ê</span>':''}${esc(l.name)}</button>`).join('');}
function selectLocation(id){selectedId=id;expandedDay=null;renderChips();fetchWeather();}

async function fetchWeather(){
const loc=selLoc();const el=document.getElementById('viewWeather');
if(!loc){el.innerHTML=emptyHTML("F√ºge einen Ort hinzu","Ort hinzuf√ºgen","showView('manage')");return;}
el.innerHTML='<div class="spinner"></div>';
try{
const p=[`latitude=${loc.latitude}&longitude=${loc.longitude}`,"current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,weather_code,cloud_cover,wind_speed_10m,wind_direction_10m,wind_gusts_10m,surface_pressure","daily=weather_code,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,sunrise,sunset,daylight_duration,sunshine_duration,uv_index_max,precipitation_sum,precipitation_probability_max,wind_speed_10m_max,wind_gusts_10m_max","hourly=temperature_2m,relative_humidity_2m,precipitation_probability,precipitation,weather_code,cloud_cover,wind_speed_10m,wind_direction_10m,is_day","timezone=auto&forecast_days=16&wind_speed_unit=kmh"].join("&");
const r=await fetch("https://api.open-meteo.com/v1/forecast?"+p);if(!r.ok)throw new Error("HTTP "+r.status);
weatherData=await r.json();cacheWeather(loc.id,weatherData);document.getElementById('offlineBar').classList.remove('show');processHourly();renderWeather();
}catch(e){const c=getCachedWeather(loc.id);if(c){weatherData=c;processHourly();renderWeather();document.getElementById('offlineBar').classList.add('show');}else{el.innerHTML=`<div class="err-box">‚ö†Ô∏è ${esc(e.message)}<button onclick="fetchWeather()">Erneut</button></div>`;}}}

function processHourly(){hourlyGrouped={};if(weatherData&&weatherData.hourly){weatherData.hourly.time.forEach((t,i)=>{const dt=t.split("T")[0];if(!hourlyGrouped[dt])hourlyGrouped[dt]=[];hourlyGrouped[dt].push({time:t,temp:weatherData.hourly.temperature_2m[i],pp:weatherData.hourly.precipitation_probability[i],wc:weatherData.hourly.weather_code[i],ws:weatherData.hourly.wind_speed_10m[i],day:weatherData.hourly.is_day[i]});});}}

function renderWeather(){
const el=document.getElementById('viewWeather');const loc=selLoc();
if(!loc){el.innerHTML=emptyHTML("F√ºge einen Ort hinzu","Ort hinzuf√ºgen","showView('manage')");return;}
if(!weatherData)return;const c=weatherData.current,d=weatherData.daily;if(!c||!d)return;
const wi=wmo(c.weather_code,c.is_day);
const allMin=Math.min(...d.temperature_2m_min.filter(v=>v!=null)),allMax=Math.max(...d.temperature_2m_max.filter(v=>v!=null)),range=allMax-allMin||1;
let h=`<div class="hero"><div class="bg-icon">${wi.icon}</div><div class="hero-top"><div><div class="loc">${esc(loc.name)}${loc.admin1?', '+esc(loc.admin1):''}</div><div class="temp-row"><span class="temp">${Math.round(c.temperature_2m)}¬∞</span><span class="unit">C</span></div><div class="desc">${wi.label}</div></div><div class="icon-big">${wi.icon}</div></div><div class="stats">${stat("Gef√ºhlt",Math.round(c.apparent_temperature)+"¬∞")}${stat("Feuchte",c.relative_humidity_2m+"%")}${stat("Wind",Math.round(c.wind_speed_10m)+" km/h",windDir(c.wind_direction_10m))}${stat("B√∂en",Math.round(c.wind_gusts_10m)+" km/h")}${stat("Druck",Math.round(c.surface_pressure)+" hPa")}${stat("Wolken",c.cloud_cover+"%")}</div></div><div class="strip">${tile("üåÖ","Aufgang",fmtTime(d.sunrise[0]))}${tile("üåá","Untergang",fmtTime(d.sunset[0]))}${tile("‚òÄÔ∏è","UV-Index",(d.uv_index_max[0]||0).toFixed(1))}</div><div class="sec-title">16-Tage Vorhersage</div>`;
d.time.forEach((date,i)=>{const fd=fmtDay(date),isOpen=expandedDay===i,left=((d.temperature_2m_min[i]-allMin)/range)*100,w=((d.temperature_2m_max[i]-d.temperature_2m_min[i])/range)*100;
h+=`<button class="fday ${isOpen?'open':''}" onclick="toggleDay(${i})"><div><div class="d-name">${i===0?'Heute':fd.short}</div><div class="d-date">${fd.date}</div></div><div class="d-icon">${wmo(d.weather_code[i],true).icon}</div><div class="tbar"><div class="tbar-fill" style="left:${left}%;width:${Math.max(w,3)}%"></div></div><div class="temps"><span class="lo">${Math.round(d.temperature_2m_min[i])}¬∞</span><span class="sep">/</span><span class="hi">${Math.round(d.temperature_2m_max[i])}¬∞</span></div><div class="arrow">‚ñº</div></button>`;
if(isOpen){const dh=hourlyGrouped?.[date]||[];h+=`<div class="detail"><div class="sum">${stat("Regen",(d.precipitation_sum[i]||0).toFixed(1)+" mm")}${stat("Regenw.",(d.precipitation_probability_max[i]||0)+"%")}${stat("Wind max",Math.round(d.wind_speed_10m_max[i])+" km/h")}${stat("B√∂en max",Math.round(d.wind_gusts_10m_max[i])+" km/h")}${stat("UV",(d.uv_index_max[i]||0).toFixed(1))}${stat("Sonne",Math.round((d.sunshine_duration[i]||0)/3600)+"h")}</div><div class="hours">`;dh.filter((_,j)=>j%2===0).forEach(x=>{const hi=wmo(x.wc,x.day);h+=`<div class="hcell"><div class="ht">${fmtTime(x.time)}</div><div class="hi">${hi.icon}</div><div class="ht2">${Math.round(x.temp)}¬∞</div>${x.pp>0?`<div class="hp">üíß${x.pp}%</div>`:''}<div class="hw">${Math.round(x.ws)} km/h</div></div>`;});h+=`</div></div>`;}});
h+=`<div class="attr">Daten: <a href="https://open-meteo.com" target="_blank">Open-Meteo.com</a> ¬∑ CC BY 4.0</div>`;el.innerHTML=h;}
function toggleDay(i){expandedDay=expandedDay===i?null:i;renderWeather();if(expandedDay!==null)setTimeout(()=>{const o=document.querySelector('.fday.open');if(o)o.scrollIntoView({behavior:'smooth',block:'start'});},50);}

function renderManage(){const el=document.getElementById('viewManage');let h=`<div style="font-size:18px;font-weight:600;margin-bottom:4px">Meine Orte</div><div style="font-size:13px;color:var(--dim);margin-bottom:18px">‚≠ê = Standardort</div>`;if(!locations.length){el.innerHTML=h+emptyHTML("Keine Orte","Ort suchen","showSearchMode()");return;}locations.forEach(l=>{const isDef=l.id===defaultId;h+=`<div class="loc-row ${isDef?'is-def':''}"><button class="star-btn" onclick="toggleDefault('${l.id}')">‚≠ê</button><div class="info"><div class="name">${esc(l.name)}</div><div class="sub">${esc([l.admin1,l.country].filter(Boolean).join(', '))}</div></div>${isDef?'<span class="def-badge">STANDARD</span>':''}<button class="btn-sm" onclick="selectAndShow('${l.id}')">Anzeigen</button><button class="btn-sm btn-rm" onclick="removeLoc('${l.id}')">‚úï</button></div>`;});h+=`<button class="btn-add" onclick="showSearchMode()">+ Ort hinzuf√ºgen</button>`;el.innerHTML=h;}
function toggleDefault(id){defaultId=defaultId===id?null:id;saveDef();renderManage();renderChips();}
function removeLoc(id){locations=locations.filter(l=>l.id!==id);saveLocs();if(defaultId===id){defaultId=locations.length?locations[0].id:null;saveDef();}if(selectedId===id){selectedId=locations.length?locations[0].id:null;weatherData=null;}renderManage();renderChips();}
function selectAndShow(id){selectedId=id;expandedDay=null;showView('weather');fetchWeather();}

function showSearchMode(){const el=document.getElementById('viewManage');el.innerHTML=`<div style="display:flex;align-items:center;gap:10px;margin-bottom:14px"><button onclick="renderManage()" style="background:var(--card);border:1px solid var(--bdr);border-radius:10px;padding:8px 12px;color:var(--txt);cursor:pointer;font-size:14px">‚Üê Zur√ºck</button><div style="font-size:18px;font-weight:600">Ort suchen</div></div><div class="search-wrap"><span class="sicon">üîç</span><input id="searchInput" type="text" placeholder="Stadt oder PLZ..." oninput="onSearchInput(this.value)" autocomplete="off"></div><div id="searchResults"><div class="hint"><div class="hic">üåç</div><p>Mind. 2 Zeichen</p></div></div>`;setTimeout(()=>{const i=document.getElementById('searchInput');if(i)i.focus();},100);}
function onSearchInput(v){if(searchTimeout)clearTimeout(searchTimeout);searchTimeout=setTimeout(()=>doGeoSearch(v),400);}
async function doGeoSearch(term){const el=document.getElementById('searchResults');if(!el)return;if(term.length<2){el.innerHTML='<div class="hint"><div class="hic">üåç</div><p>Mind. 2 Zeichen</p></div>';return;}el.innerHTML='<div class="spinner sm"></div>';try{const r=await fetch("https://geocoding-api.open-meteo.com/v1/search?name="+encodeURIComponent(term)+"&count=8&language=de");if(!r.ok)throw new Error("HTTP "+r.status);const d=await r.json(),res=d.results||[];if(!res.length){el.innerHTML=`<div style="padding:28px;text-align:center;color:var(--dim);font-size:14px">Keine Orte f√ºr ‚Äû${esc(term)}"</div>`;return;}el.innerHTML=res.map(r=>{const ex=locations.find(l=>l.id===String(r.id)),sub=[r.admin1,r.admin2,r.country].filter(Boolean).join(', ')+(r.population?` ¬∑ ${(r.population/1000).toFixed(0)}k`:'');return`<button class="sresult" onclick='addFromSearch(${JSON.stringify({id:r.id,name:r.name,latitude:r.latitude,longitude:r.longitude,country:r.country||"",admin1:r.admin1||""}).replace(/'/g,"&#39;")})'><span class="pin">üìç</span><div class="sinfo"><div class="sname">${esc(r.name)}</div><div class="ssub">${esc(sub)}</div></div>${ex?'<span class="exists">‚úì</span>':'<span class="plus">+</span>'}</button>`;}).join('');}catch(e){el.innerHTML=`<div class="err-box">‚ö†Ô∏è ${esc(e.message)}<button onclick="doGeoSearch(document.getElementById('searchInput')?.value||'')">Erneut</button></div>`;}}
function addFromSearch(r){const e={id:String(r.id),name:r.name,latitude:r.latitude,longitude:r.longitude,country:r.country,admin1:r.admin1};if(locations.find(l=>l.id===e.id)){selectedId=e.id;showView('weather');fetchWeather();return;}locations.push(e);saveLocs();if(locations.length===1){defaultId=e.id;saveDef();}selectedId=e.id;expandedDay=null;showView('weather');fetchWeather();}

function renderSettings(){document.getElementById('viewSettings').innerHTML=`<div style="font-size:18px;font-weight:600;margin-bottom:16px">Einstellungen</div><div class="setting-row"><div><div class="label">Farbschema</div><div class="sublabel">W√§hle dein Design</div></div><div class="theme-btns"><button class="theme-btn dark ${currentTheme==='dark'?'active':''}" onclick="setTheme('dark')">üåô</button><button class="theme-btn light ${currentTheme==='light'?'active':''}" onclick="setTheme('light')">‚òÄÔ∏è</button><button class="theme-btn weatherpro ${currentTheme==='weatherpro'?'active':''}" onclick="setTheme('weatherpro')">üíô</button></div></div><div class="attr" style="margin-top:40px"><strong>Wetter-App v2.0</strong><br>Daten: <a href="https://open-meteo.com" target="_blank">Open-Meteo.com</a><br>Netatmo: <a href="https://dev.netatmo.com" target="_blank">dev.netatmo.com</a></div>`;}

function saveNetatmoStations(){localStorage.setItem('netatmo_stations',JSON.stringify(netatmoStations));}
function renderNetatmo(){const el=document.getElementById('viewNetatmo');let h=`<div style="font-size:18px;font-weight:600;margin-bottom:4px">Netatmo Stationen</div><div style="font-size:13px;color:var(--dim);margin-bottom:16px">Deine Wetterstationen</div>`;if(!netatmoStations.length){h+=emptyHTML("Keine Station eingerichtet","Station hinzuf√ºgen","showNetatmoSetup()");}else{netatmoStations.forEach((st,idx)=>{const data=netatmoData[st.id];if(data&&data.dashboard_data){const dd=data.dashboard_data,mods=data.modules||[];h+=`<div class="netatmo-card"><div class="nc-header"><div class="nc-name">${esc(st.name||data.station_name||'Station')}</div><div class="nc-time">${dd.time_utc?fmtTimeAgo(dd.time_utc):''}</div></div><div class="nc-grid">${dd.Temperature!=null?`<div class="nc-item"><div class="nc-label">Temperatur</div><div class="nc-val">${dd.Temperature.toFixed(1)}<span class="nc-unit">¬∞C</span></div></div>`:''}${dd.Humidity!=null?`<div class="nc-item"><div class="nc-label">Luftfeuchte</div><div class="nc-val">${dd.Humidity}<span class="nc-unit">%</span></div></div>`:''}${dd.CO2!=null?`<div class="nc-item"><div class="nc-label">CO‚ÇÇ</div><div class="nc-val">${dd.CO2}<span class="nc-unit">ppm</span></div></div>`:''}${dd.Noise!=null?`<div class="nc-item"><div class="nc-label">Lautst√§rke</div><div class="nc-val">${dd.Noise}<span class="nc-unit">dB</span></div></div>`:''}${dd.Pressure!=null?`<div class="nc-item"><div class="nc-label">Luftdruck</div><div class="nc-val">${dd.Pressure.toFixed(1)}<span class="nc-unit">hPa</span></div></div>`:''}</div>`;if(mods.length){h+=`<div class="nc-modules">`;mods.forEach(m=>{const md=m.dashboard_data;if(md){let v=[];if(md.Temperature!=null)v.push(`${md.Temperature.toFixed(1)}¬∞C`);if(md.Humidity!=null)v.push(`${md.Humidity}%`);if(md.CO2!=null)v.push(`${md.CO2} ppm`);if(md.Rain!=null)v.push(`${md.Rain} mm`);if(md.WindStrength!=null)v.push(`${md.WindStrength} km/h`);h+=`<div class="nc-module"><span class="nc-mod-name">${esc(m.module_name||m.type||'Modul')}</span><span class="nc-mod-val">${v.join(' ¬∑ ')}</span></div>`;}});h+=`</div>`;}h+=`<div style="margin-top:12px;display:flex;gap:8px"><button class="btn-sm" onclick="fetchNetatmoData(${idx})" style="flex:1">üîÑ Aktualisieren</button><button class="btn-sm btn-rm" onclick="removeNetatmoStation(${idx})">‚úï</button></div></div>`;}else{h+=`<div class="netatmo-card"><div class="nc-header"><div class="nc-name">${esc(st.name||'Station')}</div></div><div style="padding:20px 0;text-align:center"><button class="btn-sm" onclick="fetchNetatmoData(${idx})">Daten laden</button></div><button class="btn-sm btn-rm" onclick="removeNetatmoStation(${idx})" style="width:100%;margin-top:8px">Entfernen</button></div>`;}});h+=`<button class="btn-add" onclick="showNetatmoSetup()">+ Station hinzuf√ºgen</button>`;}el.innerHTML=h;}

function showNetatmoSetup(){document.getElementById('viewNetatmo').innerHTML=`<div style="display:flex;align-items:center;gap:10px;margin-bottom:14px"><button onclick="renderNetatmo()" style="background:var(--card);border:1px solid var(--bdr);border-radius:10px;padding:8px 12px;color:var(--txt);cursor:pointer;font-size:14px">‚Üê Zur√ºck</button><div style="font-size:18px;font-weight:600">Station hinzuf√ºgen</div></div><div style="background:var(--card);border:1px solid var(--bdr);border-radius:14px;padding:16px;margin-bottom:16px"><div style="font-size:14px;font-weight:500;margin-bottom:8px">üìã So geht's:</div><ol style="font-size:13px;color:var(--mid);padding-left:20px;line-height:1.7"><li>Gehe zu <a href="https://dev.netatmo.com/apps" target="_blank" style="color:var(--acc)">dev.netatmo.com/apps</a></li><li>Erstelle eine App</li><li>Generiere Token mit Scope <code style="background:var(--card-h);padding:1px 5px;border-radius:4px">read_station</code></li><li>Kopiere die Daten hierher</li></ol></div><div class="form-group"><label>Name (optional)</label><input type="text" id="naName" placeholder="z.B. Zuhause"></div><div class="form-group"><label>Client ID</label><input type="text" id="naClientId"></div><div class="form-group"><label>Client Secret</label><input type="text" id="naClientSecret"></div><div class="form-group"><label>Access Token</label><input type="text" id="naAccessToken"></div><div class="form-group"><label>Refresh Token</label><input type="text" id="naRefreshToken"><div class="hint-text">F√ºr automatische Token-Erneuerung</div></div><button class="btn-primary" onclick="addNetatmoStation()">Hinzuf√ºgen</button><div id="naError" style="margin-top:12px"></div>`;}

function addNetatmoStation(){const n=document.getElementById('naName').value.trim(),ci=document.getElementById('naClientId').value.trim(),cs=document.getElementById('naClientSecret').value.trim(),at=document.getElementById('naAccessToken').value.trim(),rt=document.getElementById('naRefreshToken').value.trim();if(!ci||!cs||!at||!rt){document.getElementById('naError').innerHTML='<div class="err-box">Bitte alle Felder ausf√ºllen</div>';return;}netatmoStations.push({id:'na_'+Date.now(),name:n||'Netatmo Station',clientId:ci,clientSecret:cs,accessToken:at,refreshToken:rt,tokenUpdated:Date.now()});saveNetatmoStations();fetchNetatmoData(netatmoStations.length-1);renderNetatmo();}
function removeNetatmoStation(i){if(confirm('Station entfernen?')){netatmoStations.splice(i,1);saveNetatmoStations();renderNetatmo();}}

async function refreshNetatmoToken(i){const st=netatmoStations[i];try{const r=await fetch('https://api.netatmo.com/oauth2/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:`grant_type=refresh_token&refresh_token=${encodeURIComponent(st.refreshToken)}&client_id=${encodeURIComponent(st.clientId)}&client_secret=${encodeURIComponent(st.clientSecret)}`});if(!r.ok)throw new Error('Refresh failed');const d=await r.json();st.accessToken=d.access_token;st.refreshToken=d.refresh_token;st.tokenUpdated=Date.now();saveNetatmoStations();return true;}catch(e){return false;}}

async function fetchNetatmoData(i){const st=netatmoStations[i];if(!st)return;try{let r=await fetch('https://api.netatmo.com/api/getstationsdata',{headers:{'Authorization':'Bearer '+st.accessToken}});if(r.status===403||r.status===401){if(await refreshNetatmoToken(i)){r=await fetch('https://api.netatmo.com/api/getstationsdata',{headers:{'Authorization':'Bearer '+netatmoStations[i].accessToken}});}}if(!r.ok)throw new Error('HTTP '+r.status);const d=await r.json();if(d.body&&d.body.devices&&d.body.devices.length){netatmoData[st.id]=d.body.devices[0];localStorage.setItem('netatmo_data_'+st.id,JSON.stringify(netatmoData[st.id]));}renderNetatmo();}catch(e){try{const c=JSON.parse(localStorage.getItem('netatmo_data_'+st.id));if(c)netatmoData[st.id]=c;}catch(e2){}renderNetatmo();}}

netatmoStations.forEach(st=>{try{const c=JSON.parse(localStorage.getItem('netatmo_data_'+st.id));if(c)netatmoData[st.id]=c;}catch(e){}});
if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js').catch(()=>{});}
(function(){if(defaultId&&locations.find(l=>l.id===defaultId))selectedId=defaultId;else if(locations.length)selectedId=locations[0].id;renderChips();if(selectedId)fetchWeather();else renderWeather();})();
</script>
</body>
</html>
